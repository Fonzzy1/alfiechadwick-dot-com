<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>
<meta
  name="author"
  content="Alfie Chadwick"
/>
<meta
  name="description"
  content="Why we use Dev-Containers What I want The Beginnings Docker In Docker Secrets Management Portability Wrapping it up Like most developers, I spend an unruly amount of time dealing with my local installs and dependencies. When working across multiple projects, I find it’s not uncommon to have to deal with conflicting versions of dependencies and although virtual environments and node package manager go a long way to fixing this problem, it still often falls short."
/>
<meta
  name="keywords"
  content=", Devops, Docker, Vim"
/>
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="/2024/01/06/diy-dev-containers/" />

<title>
   DIY Dev-Containers :: Alfie Chadwick  
</title>


 
<link
  rel="stylesheet"
  href="/main.a9ab624e85e095bcf95bb267aad409c118b491d4ab8297e6d81ced1812528418.css"
  integrity="sha256-qatiToXglbz5W7JnqtQJwRi0kdSrgpfm2BztGBJShBg="
/>



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">
 <meta itemprop="name" content="DIY Dev-Containers">
<meta itemprop="description" content="Why we use Dev-Containers What I want The Beginnings Docker In Docker Secrets Management Portability Wrapping it up Like most developers, I spend an unruly amount of time dealing with my local installs and dependencies. When working across multiple projects, I find it’s not uncommon to have to deal with conflicting versions of dependencies and although virtual environments and node package manager go a long way to fixing this problem, it still often falls short."><meta itemprop="datePublished" content="2024-01-06T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-01-06T00:00:00+00:00" />
<meta itemprop="wordCount" content="1267">
<meta itemprop="keywords" content="Devops,Docker,Vim," /> <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="DIY Dev-Containers"/>
<meta name="twitter:description" content="Why we use Dev-Containers What I want The Beginnings Docker In Docker Secrets Management Portability Wrapping it up Like most developers, I spend an unruly amount of time dealing with my local installs and dependencies. When working across multiple projects, I find it’s not uncommon to have to deal with conflicting versions of dependencies and although virtual environments and node package manager go a long way to fixing this problem, it still often falls short."/>
   
<meta property="article:published_time" content="2024-01-06 00:00:00 &#43;0000 UTC" />










<link  rel='stylesheet' type='text/css' href="//cdn.jsdelivr.net/npm/@catppuccin/highlightjs@0.1.4/css/catppuccin-macchiato.css">
<style>
    pre code.hljs {
        display: block;
        overflow-x: auto;
        padding: 1em;
        background: #1e2030 ;
    }

    code.hljs {
        padding: 3px 5px;
    }
</style>











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">&gt;</span>
            <span class="logo__text ">
                $ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   background-color:#bb9af7;
                   animation-duration:2s;">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
  <ul class="menu__inner"><li><a href="/about/">About</a></li><li><a href="/post/">Posts</a></li><li><a href="/tags">Tags</a></li>
  </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
<main class="post">
  <div class="post-info">
    <p>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="feather feather-clock"
      >
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      6 minutes 
    </p>

    <p>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="feather feather-calendar"
      >
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      
       2024-01-06 

      
      
    </p>
  </div>

  <article>
    <h1 class="post-title">
      <a href="/2024/01/06/diy-dev-containers/">DIY Dev-Containers</a>
    </h1>

      

    <div class="post-content">

<div id="TOC">
<ul>
<li><a href="#why-we-use-dev-containers">Why we use Dev-Containers</a></li>
<li><a href="#what-i-want">What I want</a></li>
<li><a href="#the-beginnings">The Beginnings</a></li>
<li><a href="#docker-in-docker">Docker In Docker</a></li>
<li><a href="#secrets-management">Secrets Management</a></li>
<li><a href="#portability">Portability</a></li>
<li><a href="#wrapping-it-up">Wrapping it up</a></li>
</ul>
</div>

<p>Like most developers, I spend an unruly amount of time dealing with my local installs and dependencies. When working across multiple projects, I find it’s not uncommon to have to deal with conflicting versions of dependencies and although virtual environments and node package manager go a long way to fixing this problem, it still often falls short.</p>
<div id="why-we-use-dev-containers" class="section level1">
<h1>Why we use Dev-Containers</h1>
<p>A common answer to these issues is the use of ‘dev-containers’, which have mostly been popularised by VS Studio Code as a way to have you dependencies exist exclusively inside a Docker container, and then attach an editor to it to make your changes. Sounds great, but unfortunately for me I have years of using vim keybindings built into my muscle memory so there’s little chance of me changing my editor. So instead I thought why not just rebuild the dev containers for vim.</p>
</div>
<div id="what-i-want" class="section level1">
<h1>What I want</h1>
<p>So lets quickly scope out this project. In my dev containers, I want:</p>
<ul>
<li>Isolated Environments</li>
<li>Vim with my config built in</li>
<li>Integration with common cli tools</li>
<li>The ability to use docker from inside of the container</li>
<li>Secrets Management ( Not Having to Re-Authenticate all my tools every time I open Up a container )</li>
<li>Transportability between various unix-machines</li>
</ul>
</div>
<div id="the-beginnings" class="section level1">
<h1>The Beginnings</h1>
<p>So after doing a quick look around my system, I came up with this initial Dockerfile for my dev container:</p>
<pre class="dockerfile"><code>FROM ubuntu as setter_upper

ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Australia/Melbourne
# Enviroment Installs
RUN apt-get update &amp;&amp; apt-get install -y \
   curl git python3 python3-pip apt-transport-https \
   ca-certificates software-properties-common  libpq-dev \
   build-essential autoconf automake libtool

#Install Docker
RUN curl -fsSL https://get.docker.com -o install-docker.sh
RUN sh install-docker.sh


# Install GH CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
&amp;&amp; chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
&amp;&amp; echo &quot;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main&quot; | tee /etc/apt/sources.list.d/github-cli.list &gt; /dev/null \
&amp;&amp; apt update \
&amp;&amp; apt install gh -y

# git
#RUN gh auth setup-git
run git config --global user.name &quot;Fonzzy1&quot;
run git config --global user.email &quot;alfiechadwick@hotmail.com&quot;

# Set the base work dir
WORKDIR /src

# Set the mount point as the safe dir
RUN git config --global --add safe.directory /src

# Vim Setup
FROM setter_upper as vim

# Enviroment Installs
RUN apt-get update &amp;&amp; apt-get install -y software-properties-common
RUN add-apt-repository ppa:jonathonf/vim
RUN apt-get update

# Install the rest of the dependencies
RUN apt-get install -y \
    tig \
    fzf \
    pkg-config \
    texlive \
    r-base \
    pandoc \
    texlive-latex-extra \
    libcurl4-openssl-dev \
    libssl-dev \
    libxml2-dev \
    libfontconfig1-dev \
    libharfbuzz-dev \
    libfribidi-dev \
    libfreetype6-dev \
    libpng-dev \
    libtiff5-dev \
    libjpeg-dev \
    r-cran-tidyverse \
    vim-gtk3

#Install Ctags
RUN curl -L https://github.com/thombashi/universal-ctags-installer/raw/master/universal_ctags_installer.sh | bash

# Install node
RUN set -uex
RUN mkdir -p /etc/apt/keyrings
RUN curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
RUN echo &quot;deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main&quot; |  tee /etc/apt/sources.list.d/nodesource.list
RUN apt-get update &amp;&amp; apt-get install nodejs -y;


# Install the python packages
RUN pip install black pipreqs pgcli awscli socli

# Install npm packages
RUN npm install --save-dev --global prettier

# Download and Install Vim-Plug
RUN curl -fLo /root/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

# Install ACT extention
RUN mkdir -p /root/.local/share/gh/extensions/gh-act
RUN curl -L -o /root/.local/share/gh/extensions/gh-act/gh-act \
    &quot;https://github.com/nektos/gh-act/releases/download/v0.2.57/linux-amd64&quot;
RUN chmod +x /root/.local/share/gh/extensions/gh-act/gh-act


# Install R packages, tidyvverse is installed with apt
RUN R -e  &quot;install.packages(&#39;rmarkdown&#39;,  Ncpus = 6)&quot;
RUN R -e  &quot;install.packages(&#39;reticulate&#39;,  Ncpus = 6)&quot;
RUN R -e  &quot;install.packages(&#39;blogdown&#39;,  Ncpus = 6)&quot;
RUN R -e  &quot;blogdown::install_hugo()&quot;
RUN R -e  &quot;install.packages(&#39;readxl&#39;,  Ncpus = 6)&quot;
RUN R -e  &quot;install.packages(&#39;knitr&#39;,  Ncpus = 6)&quot;
RUN R -e  &quot;install.packages(&#39;tinytex&#39;,  Ncpus = 6)&quot;
RUN R -e  &quot;install.packages(&#39;languageserver&#39;,  Ncpus = 6)&quot;

# Bring in the vim config
COPY vim /root/.vim
#Copy in the dotfiles
COPY dotfiles /root

# Install Vim Plugins
RUN vim +PlugInstall +qall

# Install COC plugins
RUN mkdir -p /root/.config/coc/extensions &amp;&amp; \
    echo &#39;{&quot;dependencies&quot;:{}}&#39; &gt; /root/.config/coc/extensions/package.json &amp;&amp; \
    grep &#39;let g:coc_global_extensions&#39; /root/.vim/config/coc.vim | \
    sed &quot;s/.*\[//; s/\].*//; s/&#39;//g; s/, /\n/g&quot; | \
    while read -r extension; do \
        echo &quot;Installing coc extension: $extension&quot; &amp;&amp; \
        cd /root/.config/coc/extensions &amp;&amp; \
        npm install &quot;$extension&quot; --install-strategy=shallow --save; \
    done

CMD vim</code></pre>
<p>I won’t bother explaining most of it since its really just a heap of install statements but here are some of the interesting parts:
- I needed to add the WORKDIR to the list of safe directories for git since if I mount the file the ownership will be wrong
- I needed to manually install the gh act extension as you can’t do it normally without authenticating with a gh token, something I don’t want to do in a public container
- Coc Extentions needed to be manually installed as to stop them installing every time I started the container. Just calling <code>Vim +CocInstall</code> didn’t work because its an async process.</p>
<p>So at this point, I have the first three of my requirements done. Because I’m using docker, I have an isolated environment every time I boot up the container. Through copying over my vim config files, I have my vim config baked in, and with some of the commands in the dockerfile, I am able to have it set up. Finaly, through installing a heap of CLI tools, I am able to do most of my work from inside the vim terminal.</p>
</div>
<div id="docker-in-docker" class="section level1">
<h1>Docker In Docker</h1>
<p>The next thing to tick of the list is being able to run docker commands from within the container. Although I have installed docker, running any docker command inside the container will say the daemon isn’t running.</p>
<p>I could put in a lot of work giving the container the ability to make it’s own containers, but that would be a real pain. Instead, I can just mount the docker daemon onto the container, so that running docker commands inside the container will call the system docker.</p>
<p>To do this, I can run the container with the following command:</p>
<pre class="bash"><code>docker run -it -v /var/run/docker.sock:/var/run/docker.sock fonzzy1/vim</code></pre>
</div>
<div id="secrets-management" class="section level1">
<h1>Secrets Management</h1>
<p>The next thing to implement is secrets management. I currently have these all stored in config files in my home directory, which isn’t best practice in a docker container I want to make public. So instead, I can just put all my secrets in a .env file and reference them in the docker container. This can be done using the –env-file flag when running my docker container</p>
</div>
<div id="portability" class="section level1">
<h1>Portability</h1>
<p>The final goal on my list is making the container portable between my multiple machines. This is resolved through the use of docker hub, which will allow me to download the image from docker hub. The only other thing I need is to make sure docker is set up on the other machine. For this I wrote a quick script to do this nicely.</p>
<pre class="bash"><code>#!/bin/bash
set -e

# Dot Progress Indicator
progress() {
    local pid=$2 # PID of the process we&#39;re waiting for
    local text=$1
    local delay=2 # 2-second delay between dots
    local dot=&quot;.&quot;

    printf &quot;%s:&quot; &quot;$text&quot;
    while [ &quot;$(ps a | awk &#39;{print $1}&#39; | grep -w $pid)&quot; ]; do
        printf &quot;%s&quot; &quot;$dot&quot;
        sleep $delay
    done
    printf &quot; Done!\n&quot;
}

progress &quot;Updating package list&quot; $(sudo apt-get update &gt; /dev/null 2&gt;&amp;1 &amp; echo $!)

progress &quot;Installing Useful Packages&quot; $(sudo apt-get install -y curl &gt; /dev/null 2&gt;&amp;1 &amp; echo $!)

progress &quot;Fetching Docker Install Script&quot; $(curl -fsSL https://get.docker.com -o install-docker.sh &gt; /dev/null 2&gt;&amp;1 &amp; echo $!)

progress &quot;Installing Docker&quot; $(sudo sh install-docker.sh &gt; /dev/null 2&gt;&amp;1 &amp; echo $!)

progress &quot;Adding the current user to the Docker group&quot; $(sudo usermod -aG docker $USER &gt; /dev/null 2&gt;&amp;1 &amp; echo $!)

progress &quot;Pulling Image&quot; docker pull fonzzy1/vim

echo &quot;Setup complete!&quot;</code></pre>
</div>
<div id="wrapping-it-up" class="section level1">
<h1>Wrapping it up</h1>
</div>
</div>
  </article>

  <hr />

  <div class="post-info">
    
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="/tags/devops/">Devops</a></span>
        <span class="tag"><a href="/tags/docker/">Docker</a></span>
        <span class="tag"><a href="/tags/vim/">Vim</a></span>
        
    </p>
 

    <p>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="feather feather-file-text"
      >
        <path
          d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
        ></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      1267 Words
    </p>
  </div>

  
</main>

            </div>

            
                <footer class="footer">
  



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/matlab.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dockerfile.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  <script src="/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>



    
    <script src="/js/menu.js"></script>
</footer>

</body>
</html>

            
        </div>

           

    </body>
</html>
