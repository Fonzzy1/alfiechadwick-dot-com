---
title: 'Predicting the 2023 Hottest 100'
author: 'Alfie Chadwick'
date: '2024-01-26'
lastmod: "`r Sys.Date()`"
Tags: ['Music', 'Stats', 'Visualizations', 'ML']
output:
  blogdown::html_page
---


```{R setup,  include=FALSE}

library(tidyverse)
library(catppuccin)
library(jsonlite)
library(patchwork)
library(lubridate)

knitr::opts_chunk$set( echo = FALSE, warning = FALSE, message = FALSE)


theme_dark_catppuccino <- function(base_size = 11, base_family = "") {
  theme_minimal(base_size = base_size, base_family = base_family) +
    theme(
      # Define colors
      text = element_text(color = "#cad3f5"),
      
      # Background colors
      plot.background = element_rect(fill = "#24273a", color = NA),
      panel.background = element_rect(fill = "#1e2030", color = NA),
      plot.margin = margin(5.5, 5.5, 5.5, 5.5, "pt"),

      # Grid colors
      panel.grid.major = element_line(color = "#494d64", size = 0.25),
      panel.grid.minor = element_line(color = "#494d64", size = 0.25),
      
      # Axis colors and ticks
      axis.ticks = element_line(color = "#cad3f5"),
      axis.text = element_text(color = "#cad3f5"),
      axis.title = element_text(color = "#cad3f5"),
      axis.line = element_line(color = "#cad3f5"),
      
      # Legend colors
      legend.background = element_rect(fill = "#363a4f"),
      legend.text = element_text(color = "#cad3f5"),
      legend.title = element_text(color = "#cad3f5", face = "bold"),
      legend.position = "none",

      # Title and subtitle
      plot.title = element_text(color = "#b7bdf8", size = base_size * 1.2, 
                                hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(color = "#b7bdf8", size = base_size * 0.9,
                                   hjust = 0.5),
                                   
      # Caption
      plot.caption = element_text(color = "#f4dbd6", hjust = 0.5, 
                                  size = base_size * 0.8)
    )
}

theme_set(theme_dark_catppuccino())

```

Like many Australians, I spend my last Saturday in January getting hyped for the Triple J Hottest 100 countdown. 
And for the last few years, there's been a project run by [100 Warm Tunas](https://100warmtunas.com/) that has been really accurate at predicting the results of the countdown.
Warm tuna makes predictions by scraping social media posts for peoples votes and then collating them as a sample of all votes, and although this is very effective, I feel misses the point a bit in trying to work out why a song is popular.

So I've set out this year to try and work out what songs will come top in the 2023 countdown, without looking at anything related to the voting itself.

## My Hypotheses

Heading into this, I have a few ideas as to factors that will make a song perform well in the countdown:


### Plays on Triple J

I feel this factor is pretty self explanatory, if a song is being played a lot on triple j, it's most likely popular with the listener base and will get more votes in the Hottest 100

### Chart Success

This one is a bit weirder, as I don't think that just getting to number one in the aria charts will make you a top pick for triple j listeners, or else the countdown would be topped by the years biggest Pop hits. If a song is too popular in the mainstream it seems falls out of favour with triple J listeners, however there are some notable exceptions to this such as Bad Guy by Billie Eilish and Thift Shop by Macklemore who both too out the top spot in their respective years.


### Time of Release and Peak

This idea is commonly thrown around when talking about the Oscars, so I feel that it's probably going to be applicable to the hottest 100 as well. Being at peak popularity when people are voting is probably going to be usefull. Similarly, a song that hung around for a long time will probably be voted for more than a song that only hung around for a week.


# Play Data

I gathered the data for all plays on Triple J for the last 8 years from their [API](https://music.abcradio.net.au/api/v1/plays/search.json?limit=100&offset=0&page=0&station=triplej), which left me a data set looking like this:

```{R dataset, echo = FALSE}

results_files <- c('2016_results.csv', '2017_results.csv', '2018_results.csv', '2019_results.csv', '2020_results.csv', '2021_results.csv', '2022_results.csv')
plays_files <- c('2016_filtered.json', '2017_filtered.json', '2018_filtered.json', '2019_filtered.json', '2020_filtered.json', '2021_filtered.json', '2022_filtered.json', '2023_filtered.json')

# Read in the results data to dataframes and add a year column
results <- lapply(results_files, function(file) {
  data <- read.csv(paste('data/', file, sep=''))
  # Extract the year from the file name and add it as a column
  year <- as.numeric(sub("_results.csv", "", file))
  data$Year <- year
  return(data)
})

# Read in the plays data to dataframes and add a year column
plays <- lapply(plays_files, function(file) {
  data <- fromJSON(paste('data/', file, sep=''))
  # Extract the year from the file name and add it as a column
  year <- as.numeric(sub("_filtered.json", "", file))
  data$Year <- year
  return(data)
})

# Assuming you want to combine all dataframes of each type (results, plays) into one dataframe
# Combine all the results into one dataframe
combined_results <- do.call(rbind, results)

# Combine all the plays into one dataframe
combined_plays <- do.call(rbind, plays)

head(combined_results)
head(combined_plays)


p1 <- ggplot(combined_plays, ) +
  geom_bar(aes(x=factor(Year), fill=factor(Year)), show.legend = FALSE ) +
  scale_fill_catppuccin(palette="macchiato") +
  labs(x="Year", y="Number of Played Songs") +
  ggtitle('Total Plays By Years')


p2 <- combined_plays %>%
  distinct(release_year, title, artist) %>%
  count(release_year, name = "num_unique_pairs") %>%
  filter(release_year >= 2016, release_year <= 2023) %>%
  ggplot(aes(x = release_year, y = num_unique_pairs, fill = factor(release_year))) +
  geom_bar(stat = "identity") +
  labs(title = "Number of Songs Eligible Each Year",
       x = "Release Year",
       y = "Number of Songs") +
  scale_fill_catppuccin(palette="macchiato") 


p1 

p2
```


## Number of Plays

To me, the most obvious indicator of a song being popular is the number of plays that it gets, so we can start by looking at that.

```{R plays, echo = FALSE}

combined_plays %>%
  filter(release_year >= 2016 & release_year <= 2023) %>%
  filter(release_year == year(ymd_hms(timestamp))) %>%
  group_by(release_year, title, artist) %>%
  summarize(
    first_timestamp = ymd_hms(min(timestamp)),
    total_plays = n(),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = first_timestamp, y = total_plays, color = factor(release_year))) +
  geom_point() +
  scale_color_catppuccin(palette = "macchiato") +
  labs(x = "Date of First Play", y = "Total Number of Plays", title = "Total Number of Plays In Release Year", color = 'Release Year') +
  theme(axis.text.x = element_blank(), legend.position = 'right') +
  scale_y_continuous(limit = c(0, NA))

combined_plays %>%
  filter(release_year >= 2016 & release_year <= 2023) %>%
  filter(release_year == year(ymd_hms(timestamp))) %>%
  count(title) %>%
  group_by(n) %>%
  summarize(number_of_songs = n(), .groups = "drop")  %>%
    ggplot(aes(x = n, y = number_of_songs)) +
      geom_line(color = "#cad3f5") + # Changed to line chart
      geom_point(color = '#bb9af7') + # You can keep points to show exact data spots
      labs(x = "Total Number of Plays", y = "Number of Songs", title = "Line Chart of Songs vs Total Plays by Release Year") +
      theme(legend.position = 'bottom') +
      scale_y_log10()

```

These plots give us a good insight into the trends in how Triple J picks songs. We have a lot of songs with almost no plays, which are mostly songs that are being presented to the audience to gauge the reaction. If they take off, the songs will be played a lot, signified by the lack of songs siting around the 40-60 plays mark. But very few get played an excessive amount, with very few making it past the 200 mark.

We can also see here some impact of being released early in the year,  as these songs have the opportunity to be played more in a year, hence the downward slope over for each year.

```{R plays-vs-success , echo = FALSE, results='hide'}
combined_results <- combined_results %>%
  mutate(
    Song = tolower(str_remove_all(Song, "\\s*[\\(\\)\\[\\]\\{\\}].*?[\\(\\)\\[\\]\\{\\}]")) %>%
            str_trim(),
    Artist = tolower(str_replace_all(Artist, "\\s*(?:feat[.:\\s]|ft[.:\\s]|featuring[.:\\s])", "&")) %>%
              str_trim() # replace ampersands with 'and'
  )

combined_plays <- combined_plays %>%
  mutate(
    title = tolower(str_remove_all(title, "\\s*[\\(\\)\\[\\]\\{\\}].*?[\\(\\)\\[\\]\\{\\}]")) %>%
            str_trim(),
    artist = tolower(str_replace_all(artist, "\\s*(?:feat[.:\\s]|ft[.:\\s]|featuring[.:\\s])", "&")) %>%
              str_trim() # replace ampersands with 'and'
  )

combined_data <- combined_results %>%
  left_join(combined_plays, by = c("Song" = "title", "Artist" = "artist", 'Year'='Year')) %>%
  filter(Year == year(ymd_hms(timestamp))) 
 



 combined_data %>%
 group_by(Song, Artist, rank, Year) %>%
  summarise(number_of_plays = n(), .groups="drop") %>%
  filter(number_of_plays > 1) %>%
ggplot( aes(x = rank, y = number_of_plays, color = factor(Year)))+
  geom_point()+
  scale_color_catppuccin(palette = "macchiato") +
  geom_smooth(color = "#cad3f5")+
  theme(legend.position = 'right') +
  labs(title = 'Position vs Plays', x = 'Final Position', y = "Number of Plays", color = 'Year')
```

Now looking at the final ranking vs the number of plays, we can see that surprisingly, the total number of plays had very little impact on the results. As expected, most songs that got into the hottest 100 were in that pool of songs that got more than 100 plays, but weather they were rank 100 or rank 1 is impossible to tell.

```{R plays-vs-success-accounting-for-time , echo = FALSE, results='hide', messae = FALSE}

combined_data %>%
  group_by(Song, Artist, rank, Year, week(ymd_hms(timestamp))) %>%
  summarise(number_of_plays_per_week = n(), .groups="drop") %>%
  filter(number_of_plays_per_week > 7) %>%
  group_by(Song, Artist, rank, Year) %>% 
  summarise(peak = n(), .groups="drop") %>%
ggplot( aes(y = rank, x = peak, color = factor(Year)))+
  geom_point()+
  scale_color_catppuccin(palette = "macchiato") +
  geom_smooth(color = "#cad3f5")+
  theme(legend.position = 'right') +
  labs(title = 'Position vs Number of Weeks With More than 7 Plays', y = 'Final Position', x = "Number of Weeks", color = 'Year')

combined_data %>%
  group_by(Song, Artist, rank, Year, week(ymd_hms(timestamp))) %>%
  summarise(number_of_plays_per_week = n(), .groups="drop") %>%
  group_by(Song, Artist, rank, Year) %>%
  summarise(peak = max(number_of_plays_per_week), .groups="drop") %>%
ggplot( aes(y = rank, x = peak, color = factor(Year)))+
  geom_point()+
  scale_color_catppuccin(palette = "macchiato") +
  geom_smooth(color = "#cad3f5")+
  theme(legend.position = 'right') +
  labs(title = 'Position vs Peak Plays Per Week', y = 'Final Position', x = "Number of Plays", color = 'Year')
  
combined_data %>%
  group_by(Song, Artist, rank, Year, week(ymd_hms(timestamp))) %>%
  summarise(number_of_plays_per_week = n(), .groups="drop") %>%
  group_by(Song, Artist, rank, Year) %>%
  summarise(peak = mean(number_of_plays_per_week), .groups="drop") %>%
ggplot( aes(y = rank, x = peak, color = factor(Year)))+
  geom_point()+
  scale_color_catppuccin(palette = "macchiato") +
  geom_smooth(color = "#cad3f5")+
  theme(legend.position = 'right') +
  labs(title = 'Position vs Mean Plays Per Week after First Play', y = 'Final Position', x = "Number of Plays", color = 'Year')

```

The weekly play numbers try to remove any advantage that songs that were released earlier in the year may have had, and again, we see very little regarding a relationship between the number of plays that a song got and its performance.


## Timing

Another thing I wanted to look at was when and how the songs peaked in the play data.

```{R week-of-peak , echo = FALSE, results='hide', messages = FALSE, warnings = FALSE}

combined_data %>%
  mutate(Week = week(ymd_hms(timestamp)), Year = year(ymd_hms(timestamp))) %>%
  group_by(Song, Artist, Rank=rank, Year, Week) %>%
  summarise(plays = n(), .groups = "drop") %>%
  group_by(Song, Artist, Rank, Year) %>%
  slice_max(order_by = plays, n = 1) %>%
  ungroup() %>%
ggplot( aes(x = Week, y = Rank, color = factor(Year))) +
  geom_point()+
  geom_smooth() +
  scale_color_catppuccin(palette = "macchiato", discrete) +
  labs(title = 'Week of Peak', x = 'Week', y = "Rank", color = 'Year')

combined_data %>%
  mutate(Week = week(ymd_hms(timestamp)), Year = year(ymd_hms(timestamp))) %>%
  group_by(Song, Artist, Rank=rank, Year) %>%
  slice_min(order_by = timestamp, n = 1) %>%
  ungroup()  %>%
ggplot( aes(x = Week, y = Rank, color = factor(Year))) +
  geom_point()+
  geom_smooth(aes(group = 1), se = FALSE) + # Single smooth line for all data
  scale_color_catppuccin(palette = "macchiato", discrete) +
  labs(title = 'Week of first play', x = 'Week', y = "Rank", color = 'Year')

```



```{R multiline , echo = FALSE, results='hide', messages = FALSE, warnings = FALSE}

combined_data %>%
  mutate(Week = week(ymd_hms(timestamp))) %>%
  filter(rank < 4 ) %>%
  group_by(Song, Artist, rank, Year, Week) %>%
  summarise(plays = n(), .groups="drop") %>%
ggplot( aes(x = Week, y = plays, color = factor(rank), group = interaction(Song, Artist))) +
  geom_line()+
  scale_color_catppuccin(palette = "macchiato", discrete) +
  labs(title = 'Position history for Top 3 Tracks', x = 'Week', y = "Number of Plays", color = 'Rank')

combined_data %>%
  mutate(Week = week(ymd_hms(timestamp))) %>%
  filter(rank > 96 ) %>%
  group_by(Song, Artist, rank, Year, Week) %>%
  summarise(plays = n(), .groups="drop") %>%
ggplot( aes(x = Week, y = plays, color = factor(rank), group = interaction(Song, Artist))) +
  geom_line()+
  scale_color_catppuccin(palette = "macchiato", discrete) +
  labs(title = 'Position history for Bottom 3 Tracks', x = 'Week', y = "Number of Plays", color = 'Rank')
  
```


# Where we are going wrong


```{R overall}

combined_plays <- combined_plays %>% mutate(Year = year(ymd_hms(timestamp)))

combined_data_full <- combined_results %>%
  right_join(combined_plays, by = c("Song" = "title", "Artist" = "artist", 'Year' = 'Year')) %>%
  filter(Year == year(ymd_hms(timestamp)))


combined_data_full %>%
  group_by(Song, Artist, rank, Year) %>%
  summarise(
    number_of_plays = n(),
    first_timestamp = min(timestamp),
    .groups = "drop"
  ) %>%
  mutate(
    DayTime = paste(yday(first_timestamp), format(first_timestamp, "%H:%M:%S"), sep=" ")
  ) %>%
  filter(number_of_plays > 1) %>%
  mutate(rank_na = ifelse(is.na(rank), "No", "Yes")) %>%
  ggplot(aes(x = DayTime, y = number_of_plays, color = rank_na)) +
  geom_point() +
  labs(x = "Day and Time of First Play in the Year", y = "Total Number of Plays", title = "Total Number of Plays In Release Year", color = 'Did It Make the Top 100?') +
  theme(legend.position = 'right') +
  scale_y_continuous(limit = c(0, NA)) 

```

# Fuckit XDG boost
